<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rush UE ‚Äî Visitor‚Äôs Slip</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root {
      --ue-red: #dc3545;
      --card-border: #f1c4cd;
    }

    body {
      font-family: Poppins, system-ui, Segoe UI, Arial, sans-serif;
      background: linear-gradient(to bottom, #fbd1dc, #fff);
      min-height: 100vh;
      display: flex;
      flex-direction: column
    }

    .navbar {
      background: #fff
    }

    .navbar-brand img {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 5px 15px rgba(220, 53, 69, .3)
    }

    .navbar-text-center {
      font-weight: 600;
      font-size: clamp(1.05rem, 2vw + .6rem, 1.5rem);
      color: var(--ue-red);
      margin-left: 12px
    }

    .ue-card {
      background: #fff;
      border: 1px solid var(--card-border);
      border-radius: 18px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, .08)
    }

    .form-label {
      font-weight: 600
    }

    .hint {
      font-size: .85rem;
      color: #6c757d
    }

    input.form-control,
    select.form-select {
      min-height: 44px;
      font-size: 1rem
    }

    .ue-toast {
      position: fixed;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(90deg, #fff, #fff1f2);
      border: 1px solid #ffd7dc;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, .1);
      z-index: 9999;
      max-width: min(92vw, 520px);
      text-align: center
    }

    footer {
      background: var(--ue-red);
      color: #fff;
      font-size: .95rem
    }

    #ueSlipMap {
      width: 100%;
      height: 320px;
      border: 1px solid #eee;
      border-radius: 14px;
      overflow: hidden;
      background: #fff
    }

    @media (min-width:768px) {
      #ueSlipMap {
        height: 420px
      }
    }

    .walker {
      font-size: 20px;
      line-height: 1;
      transform: translate(-50%, -60%);
      animation: bob 1.2s ease-in-out infinite;
      filter: drop-shadow(0 2px 2px rgba(0, 0, 0, .25))
    }

    @keyframes bob {

      0%,
      100% {
        transform: translate(-50%, -60%)
      }

      50% {
        transform: translate(-50%, -66%)
      }
    }

    .poi {
      background: #fff;
      border: 1px solid #e3e3e3;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .06)
    }

    #profChoiceWrap .form-select {
      min-height: 44px
    }
  </style>
  <style>
    :root {
      --bg-color: linear-gradient(to bottom, #fbd1dc, #fff);
      --header-bg: rgba(255, 255, 255, 0.9);
      --header-title-color: #dc3545;
      --text-color: #333;
      --card-bg: rgba(255, 255, 255, 0.6);
      --card-hover-bg: linear-gradient(145deg, #ffe0e8, #fff);
      --primary-red: #dc3545;
      --footer-bg: #dc3545;
      --news-bg: rgba(255, 255, 255, 0.6);
      --news-border: #eee;
      --page-bg: rgba(255, 255, 255, 0.85);
      --page-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      --status-danger: #dc3545;
      --status-primary: #0d6efd;
      --status-success: #198754;
      --status-secondary: #6c757d;
    }

    .dark-mode {
      --bg-color: linear-gradient(to bottom, #1a0000, #3d0000);
      --header-bg: rgba(50, 0, 0, 0.9);
      --header-title-color: #ffdde1;
      --text-color: #ffdde1;
      --card-bg: rgba(70, 0, 0, 0.7);
      --card-hover-bg: linear-gradient(145deg, #a00000, #600000);
      --primary-red: #ff4d4d;
      --footer-bg: #1a0000;
      --news-bg: rgba(70, 0, 0, 0.7);
      --news-border: #444;
      --page-bg: rgba(50, 0, 0, 0.95);
      --page-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);

      --status-danger: #ff6b6b;
      --status-primary: #74aeff;
      --status-success: #6be3a9;
      --status-secondary: #aaaaaa;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      position: relative;
      color: var(--text-color);
      transition: background 0.5s ease, color 0.5s ease;
    }

    .page-content {
      display: none;
    }

    .page-content.active {
      display: block;
    }

    .animated-bg,
    .animated-bg2 {
      position: fixed;
      z-index: 0;
      border-radius: 50%;
      opacity: 0.3;
      filter: blur(80px);
      transition: background 0.5s ease;
    }

    .animated-bg {
      top: -100px;
      left: -100px;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, var(--primary-red), var(--card-bg));
      animation: float 10s ease-in-out infinite;
    }

    #scannerArea {
      margin-top: 20px;
    }

    video {
      width: 100%;
      border: 1px solid #ccc;
    }

    #canvas {
      display: none;
    }

    .ue-toast {
      position: fixed;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(90deg, #fff, #fff1f2);
      padding: 12px 16px;
      border-radius: 12px;
      z-index: 9999;
      max-width: 92vw;
      text-align: center;
    }

    .animated-bg2 {
      bottom: -120px;
      right: -120px;
      width: 250px;
      height: 250px;
      background: radial-gradient(circle, var(--primary-red), var(--card-bg));
      animation: float2 12s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0) translateX(0);
      }

      50% {
        transform: translateY(20px) translateX(10px);
      }
    }

    @keyframes float2 {

      0%,
      100% {
        transform: translateY(0) translateX(0);
      }

      50% {
        transform: translateY(-15px) translateX(-20px);
      }
    }

    .header-container {
      background-color: var(--header-bg);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-title {
      font-weight: 600;
      font-size: 1.8rem;
      color: var(--header-title-color);
      margin-left: 15px;
      transition: color 0.5s ease;
    }

    .header-container .logo-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
      border: 3px solid var(--primary-red);
    }

    .dashboard-container,
    .page-container {
      flex: 1;
      position: relative;
      z-index: 1;
    }

    .page-card {
      background: var(--page-bg);
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--page-shadow);
      border: 1px solid rgba(255, 255, 255, 0.4);
      transition: all 0.5s ease;
      color: var(--text-color);
    }

    .card-dashboard {
      border: none;
      border-radius: 16px;
      text-align: center;
      transition: all 0.3s ease;
      padding: 30px 15px;
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      box-shadow: 6px 6px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.4);
      cursor: pointer;
    }

    .card-dashboard i {
      font-size: 2.5rem;
      color: var(--primary-red);
      margin-bottom: 12px;
      transition: transform 0.3s ease, color 0.3s ease;
    }

    .card-dashboard:hover {
      transform: translateY(-8px);
      background: var(--card-hover-bg);
      box-shadow: 0 12px 30px rgba(220, 53, 69, 0.25), 0 0 15px rgba(255, 255, 255, 0.3);
      border: 1px solid var(--primary-red);
    }

    .card-dashboard:hover i {
      transform: scale(1.2);
      color: #ff6f61;
    }

    .card-dashboard h6 {
      font-weight: 600;
      margin: 0;
      font-size: 1rem;
      color: var(--text-color);
      transition: color 0.5s ease;
    }

    .news-feed-card {
      background: var(--news-bg);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 6px 6px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .news-item {
      border-bottom: 1px solid var(--news-border);
      padding: 10px 0;
      color: var(--text-color);
    }

    .news-item:last-child {
      border-bottom: none;
    }

    footer {
      background-color: var(--footer-bg);
      color: white;
      font-size: 0.9rem;
      z-index: 2;
      transition: background-color 0.5s ease;
    }

    footer a {
      color: #fff;
      text-decoration: underline;
    }

    #greeting-text {
      font-size: 1.1rem;
      font-weight: 400;
      color: var(--text-color);
      margin-bottom: 0;
      transition: color 0.5s ease;
    }

    #theme-toggle {
      color: var(--primary-red);
      transition: color 0.3s ease;
    }

    .dark-mode #theme-toggle {
      color: var(--header-title-color);
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--header-bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-red);
      border-radius: 4px;
    }

    .dark-mode #news-archive-page .list-group-item {
      background-color: var(--card-bg) !important;
    }

    .dark-mode #news-archive-page .list-group-item .text-danger {
      color: var(--status-danger) !important;
    }

    .dark-mode #news-archive-page .list-group-item .text-primary {
      color: var(--status-primary) !important;
    }

    .dark-mode #news-archive-page .list-group-item .text-success {
      color: var(--status-success) !important;
    }

    .dark-mode #news-archive-page .list-group-item .text-secondary {
      color: var(--status-secondary) !important;
    }

    .dark-mode #news-archive-page .list-group-item .text-muted {
      color: var(--status-secondary) !important;
    }


    .dark-mode #news-archive-page .list-group-item:nth-child(1) {
      border-left-color: var(--status-danger) !important;
    }

    .dark-mode #news-archive-page .list-group-item:nth-child(2) {
      border-left-color: var(--status-primary) !important;
    }

    .dark-mode #news-archive-page .list-group-item:nth-child(3) {
      border-left-color: var(--status-success) !important;
    }

    .dark-mode #news-archive-page .list-group-item:nth-child(4) {
      border-left-color: var(--status-secondary) !important;
    }

    .back-button {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: white;
      color: Black;
      border: none;
      padding: 10px 20px;
      border-radius: 30px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
      z-index: 10;
    }
  </style>
</head>

<body class="light-mode">
  <div class="animated-bg"></div>
  <div class="animated-bg2"></div>

  <div class="header-container sticky-top">
    <div class="container d-flex align-items-center justify-content-between p-3 p-md-4">
      <div class="d-flex align-items-center cursor-pointer" onclick="showPage('dashboard')">
        <div class="logo-icon d-flex justify-content-center align-items-center" style="background-color: white;">
          <i class="fa-solid fa-graduation-cap text-danger" style="font-size: 2rem;"></i>
        </div>
        <h2 class="header-title">Visitor's Slip</h2>
      </div>

      <div class="d-flex align-items-center">
        <h3 id="greeting-text" class="me-3 d-none d-sm-block">Hi, Warrior!</h3>

        <button id="theme-toggle" class="btn btn-sm" onclick="toggleTheme()" aria-label="Toggle Theme">
          <i id="sun-icon" class="fa-solid fa-sun fa-xl"></i>
          <i id="moon-icon" class="fa-solid fa-moon fa-xl" style="display: none;"></i>
        </button>
      </div>
    </div>
  </div>
  <main class="dashboard-container">
    <button class="back-button" onclick="window.location.href='landingpage.html'">Back</button>
    <br><br>
    <div class="container py-4 py-md-5">
      <div class="ue-card p-3 p-md-4 p-lg-5 mx-auto" style="max-width:880px;">
        <div
          class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3">
        </div>

        <form id="visitorForm" novalidate>
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label for="vName" class="form-label">Visitor‚Äôs Name</label>
              <input id="vName" name="name" type="text" class="form-control" placeholder="Enter Your Name" required
                autocomplete="name">
            </div>
            <div class="col-12 col-md-6">
              <label for="vEmail" class="form-label">Visitor‚Äôs Email</label>
              <input id="vEmail" name="email" type="email" class="form-control" placeholder="Example@example.com"
                required autocomplete="email">
            </div>

            <div class="col-12 col-md-6">
              <label for="vDate" class="form-label">Date</label>
              <input id="vDate" name="date" type="date" class="form-control" required>
              <div class="hint mt-1"></div>
            </div>

            <div class="col-12 col-md-6">
              <label for="bldg" class="form-label">Building</label>
              <select id="bldg" class="form-select" required>
                <option value="" selected disabled>Choose building‚Ä¶</option>
                <option value="EN">Engineering Building (EN)</option>
                <option value="TYK">Tan Yan Kee Building (TYK)</option>
                <option value="LCT">Lucio Tan Building (LCT)</option>
                <option value="UEC_MAIN">UEC Main Campus (UEC)</option>
              </select>
              <div class="hint mt-1">Select a building first.</div>
            </div>

            <div class="col-12 col-md-6" id="roomCol">
              <label for="roomInput" class="form-label">Room</label>
              <input id="roomInput" class="form-control" list="roomList" placeholder="e.g., EN-405 or admission_office">
              <datalist id="roomList"></datalist>

            </div>

            <div class="col-12 col-md-6" id="profCol">
              <label for="profInput" class="form-label">Professor</label>
              <input id="profInput" class="form-control" list="profList" placeholder="Type professor‚Äôs name‚Ä¶">
              <datalist id="profList"></datalist>
            </div>

            <div class="col-12 col-md-8">
              <label for="vPurpose" class="form-label">Purpose of Visit</label>
              <select id="vPurpose" name="purpose" class="form-select" required>
                <option value="" disabled selected>Select purpose‚Ä¶</option>
                <option>Admissions / Enrollment Inquiry</option>
                <option>Registrar ‚Äî Records/TOR/Credentials</option>
                <option>Cashier ‚Äî Payment / Fees</option>
                <option>Guidance & Counseling</option>
                <option>Department Consultation (Professor/Chair)</option>
                <option>Library Use / Research</option>
                <option>Facilities / Room Viewing</option>
                <option>Event / Organization Coordination</option>
                <option>Deliveries / Supplier</option>
                <option value="__OTHER__">Others (specify)</option>
              </select>
              <div id="otherWrap" class="mt-2 d-none">
                <input id="vPurposeOther" type="text" class="form-control" placeholder="Please specify‚Ä¶">
              </div>
            </div>
          </div>
          <div class="d-grid d-sm-flex gap-2 mt-4">
            <button class="btn btn-danger w-100 w-sm-auto" type="submit"><i class="fa-solid fa-floppy-disk me-1"></i>
              Submit Visitor Slip</button>
            <button class="btn btn-outline-secondary w-100 w-sm-auto" type="button" id="btnClear"><i
                class="fa-solid fa-eraser me-1"></i> Clear</button>
          </div>

        </form>
      </div>
    </div>
  </main>

  <footer class="text-center py-4 mt-auto">
    <div class="container">
      <p class="mb-0">&copy; <span id="yy"></span> University of the East | <a href="#">Rush UE</a></p>
    </div>
  </footer>

  <div class="modal fade" id="routeModal" tabindex="-1" aria-labelledby="routeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="routeModalLabel">How to get there</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <div class="mb-2"><strong>Destination:</strong> <span id="m-destination">‚Äî</span></div>
              <div class="mb-2"><strong>Date:</strong> <span id="m-date">‚Äî</span></div>
              <div class="mb-2"><strong>Purpose:</strong> <span id="m-purpose">‚Äî</span></div>
              <div id="m-directions" class="mt-3 small"></div>
            </div>
            <div class="col-12 col-lg-6">
              <div class="mb-1 fw-semibold">Description</div>
              <div id="m-roominfo" class="border rounded p-2 small"
                style="max-height:240px; overflow:auto; white-space: pre-wrap; user-select:text;" aria-readonly="true">
              </div>

            </div>
          </div>

          <div id="ueSlipMap" class="mt-3" aria-label="Route from Gate to destination"></div>

          <div id="profChoiceWrap" class="mt-4 d-none">
            <label class="fw-semibold mb-2" for="profChoice">Select a room from the professor‚Äôs schedule:</label>
            <select id="profChoice" class="form-select"></select>
            <div class="text-muted small mt-2">Tip: pick a time/room to update the description and route.</div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script id="ue-campus-json" type="application/json">
{
  "type": "FeatureCollection",
  "features": [
    {"type":"Feature","properties":{"Building":"Cashier Office"},"geometry":{"coordinates":[120.976141,14.658306],"type":"Point"},"id":"001ff95d6b0448964db76bd4938fcdbf"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.977328,14.659885],[120.976657,14.659598],[120.976737,14.659434],[120.977418,14.659703],[120.977333,14.659882]],"type":"LineString"},"id":"01967738c58c0fa2f4ab3b9974fa9659"},
    {"type":"Feature","properties":{"Field":"Beach Volley Court"},"geometry":{"coordinates":[120.977372,14.659244],"type":"Point"},"id":"0fdd77dbee3ba4de36f382f8dfbb11fa"},
    {"type":"Feature","properties":{"Building":"Registrar's Office"},"geometry":{"coordinates":[120.97606,14.658543],"type":"Point"},"id":"17d77d14b11b9c816743c3d3e244d74f"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.976088,14.659118],[120.975797,14.658702],[120.97637,14.658441],[120.976571,14.658453],[120.977056,14.658656],[120.977537,14.658873],[120.977519,14.658911],[120.977809,14.659045],[120.977835,14.659013],[120.97788,14.659035],[120.977625,14.659565],[120.977469,14.659709],[120.976087,14.659118]],"type":"LineString"},"id":"1db9b286c672f1bfaa8a34b63942804b"},
    {"type":"Feature","properties":{"Building":"Chapel"},"geometry":{"coordinates":[120.975609,14.658078],"type":"Point"},"id":"1ea9553846a2f899bda5c5125c26fba7"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.977841,14.660118],[120.977475,14.659943],[120.977538,14.659806],[120.977616,14.659842],[120.977981,14.659122],[120.977903,14.659086],[120.977983,14.658929],[120.978379,14.659124],[120.97829,14.659289],[120.978171,14.65923],[120.977821,14.65992],[120.977916,14.65997],[120.977847,14.660115]],"type":"LineString"},"id":"2e6daf93f8eb1f25a4959068461cbfe2"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.976149,14.657996],[120.976124,14.657853],[120.97618,14.657835],[120.976208,14.657821],[120.976231,14.657919],[120.976311,14.657964],[120.976318,14.657983]],"type":"LineString"},"id":"335a91e08c3750b4337f98abc7e3a131"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.975482,14.658097],[120.975738,14.658149],[120.975762,14.658012],[120.975509,14.657963],[120.975482,14.658093],[120.975483,14.658099]],"type":"LineString"},"id":"3c7034ce0e0d9c99a268a6e40956aa57"},
    {"type":"Feature","properties":{"Entrance":"Main Entrance "},"geometry":{"coordinates":[120.976198,14.65786],"type":"Point"},"id":"4c81647b8604000d0676ea72f6f102b9"},
    {"type":"Feature","properties":{"Field":"Ue Field"},"geometry":{"coordinates":[120.976731,14.659125],"type":"Point"},"id":"54e65a1c8dbcf023be032bd00ee81bf2"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.976324,14.658207],[120.976589,14.658132],[120.976603,14.658171],[120.976742,14.658243],[120.976758,14.658219],[120.977333,14.658516],[120.977341,14.658504],[120.977562,14.658615],[120.977507,14.658715],[120.977554,14.658732],[120.977528,14.658793],[120.977481,14.658768],[120.977444,14.65882],[120.977221,14.658707],[120.977236,14.658682],[120.977113,14.658616],[120.977086,14.658655],[120.977047,14.658643],[120.97707,14.65859],[120.976855,14.658474],[120.976808,14.658487],[120.976781,14.658441],[120.976731,14.658444],[120.976713,14.658397],[120.976654,14.658406],[120.976629,14.658339],[120.976393,14.658408],[120.976322,14.658208]],"type":"LineString"},"id":"5ee5c31bc85270720ccd1b415e37b5c3"},
    {"type":"Feature","properties":{"Building":"Admin Building ( Admin )"},"geometry":{"coordinates":[120.976094,14.658429],"type":"Point"},"id":"600d9586192040184088584d89f283e8"},
    {"type":"Feature","properties":{"Building":"Comptroller's Building"},"geometry":{"coordinates":[120.976224,14.658474],"type":"Point"},"id":"63d8d85f05fc7b8ead0926e1f07e6a24"},
    {"type":"Feature","properties":{"Building":"Gym"},"geometry":{"coordinates":[120.975557,14.658325],"type":"Point"},"id":"6a68de2c1fc473186545cb12177ae3b5"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.975702,14.659098],[120.975532,14.658873],[120.975604,14.658817],[120.975647,14.658875],[120.975721,14.658826],[120.975693,14.658785],[120.97577,14.658715],[120.975934,14.658933],[120.975706,14.659097]],"type":"LineString"},"id":"6f04976fcf422f379729fb3d2862eb4b"},
    {"type":"Feature","properties":{"Building":"Admission Office"},"geometry":{"coordinates":[120.975934,14.658405],"type":"Point"},"id":"7064a2f1a21d14e9ef6d6154e738a9d1"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.975846,14.65841],[120.976266,14.658225],[120.976363,14.658436],[120.975943,14.658618],[120.975847,14.658409]],"type":"LineString"},"id":"746092b39c90dba0cc240038269b3b9b"},
    {"type":"Feature","properties":{"Building":"HRM Mock Up Building"},"geometry":{"coordinates":[120.977735,14.658825],"type":"Point"},"id":"7fd74f2ed5df921e8ddc58882ea0b8c7"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.977606,14.659111],[120.977467,14.659408],[120.977233,14.659303],[120.977371,14.659012],[120.977605,14.65911]],"type":"LineString"},"id":"84fa4ff309c2195b4a0d1b295fccfcec"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.977845,14.658987],[120.977811,14.65905],[120.977525,14.658906],[120.977557,14.658843],[120.977844,14.658987]],"type":"LineString"},"id":"85dbbfd1dc6e68b7d55565c5c644985f"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.975641,14.658488],[120.975629,14.658532],[120.975455,14.658508],[120.975463,14.658442],[120.975417,14.658431],[120.975509,14.657961],[120.975764,14.658006],[120.975674,14.65849],[120.975641,14.658486]],"type":"LineString"},"id":"a94f4679d358c358cca700009da2b450"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.976084,14.658073],[120.976083,14.658002],[120.976151,14.657997],[120.976154,14.658068],[120.976088,14.658071],[120.976352,14.658067],[120.976379,14.658034],[120.976316,14.657984],[120.976286,14.658019],[120.976353,14.658065],[120.976149,14.658],[120.976288,14.658014]],"type":"LineString"},"id":"ac3bd0567fde9c0645a4064b6065877a"},
    {"type":"Feature","properties":{"Building":"HRM Mock Up Building #2"},"geometry":{"coordinates":[120.977649,14.658923],"type":"Point"},"id":"ad09138797b0308277d2be5a0e999516"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.975636,14.658729],[120.975575,14.658624],[120.975673,14.658569],[120.975732,14.658672],[120.975639,14.658724]],"type":"LineString"},"id":"b27ff01fb035eedf7782b6f9ba048178"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.976527,14.659504],[120.97598,14.659272],[120.976036,14.659149],[120.976582,14.659381],[120.976528,14.659502]],"type":"LineString"},"id":"b3a911c3c54b9e840a27662c6ed5d55b"},
    {"type":"Feature","properties":{"Building":"Guard House"},"geometry":{"coordinates":[120.976311,14.658011],"type":"Point"},"id":"b467ef707accb1d631d0b1270c439542"},
    {"type":"Feature","properties":{"Building":"Old Academic Building"},"geometry":{"coordinates":[120.976364,14.659366],"type":"Point"},"id":"b6b333cf7040ae4644d6e79982578d49"},
    {"type":"Feature","properties":{},"geometry":{"coordinates":[[120.977917,14.658806],[120.977834,14.658955],[120.97757,14.658817],[120.977651,14.658669],[120.977918,14.658804]],"type":"LineString"},"id":"b9cf7a025ff35bc5c6d125b7981041d1"},
    {"type":"Feature","properties":{"Entrance":"Back Entrance ( Entry Point of Vehicle )"},"geometry":{"coordinates":[120.975512,14.657939],"type":"Point"},"id":"c2ea42da56637c97d191075eb875ec83"},
    {"type":"Feature","properties":{"Building":"Lucio Tan Building ( LCT )"},"geometry":{"coordinates":[120.976994,14.659653],"type":"Point"},"id":"c47537d8a99880fb8a4b15a021503de2"},
    {"type":"Feature","properties":{"Building":"Tan Yan Kee Building ( TYK )"},"geometry":{"coordinates":[120.977022,14.658458],"type":"Point"},"id":"ff62bc69d16f66c3df7727bfa766a055"}
  ]
}
</script>

  <script id="ue-paths-json" type="application/json">
{
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","properties":{"type":"path","from":"TYK 2nd Elevator","to":"Engineering Building Right Side Entrance"},"geometry":{"type":"LineString","coordinates":[[120.977177,14.658614],[120.977226,14.658534],[120.977765,14.658799],[120.977956,14.658907],[120.97797,14.659018]]},"id":"04b506ecabf97002fc4d97341cc802bf"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Registrar's Office"},"geometry":{"type":"LineString","coordinates":[[120.976197,14.657843],[120.976414,14.658365],[120.97609,14.658475],[120.976047,14.658389],[120.976089,14.658427]]},"id":"09d5b0fc0447bc55475286f866d50aa6"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"HRM Mockup Building"},"geometry":{"type":"LineString","coordinates":[[120.976201,14.657857],[120.976406,14.658362],[120.976665,14.658304],[120.977027,14.658462],[120.977399,14.658605],[120.977735,14.658788]]},"id":"0a30429547f1f215d9dad52a5dae1c52"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Gym"},"geometry":{"type":"LineString","coordinates":[[120.976202,14.657851],[120.976415,14.658357],[120.97594,14.65856],[120.975767,14.658653],[120.975699,14.658589],[120.975643,14.658523],[120.975675,14.658313]]},"id":"17b68611cc6b76d17030193e56c3a799"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Admission Building"},"geometry":{"type":"LineString","coordinates":[[120.976199,14.657852],[120.976413,14.658361],[120.976086,14.658472]]},"id":"18bdb7fbf6bafd18bb89d45e70bba7bf"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 1st Elevator","to":"Student Affairs Office"},"geometry":{"type":"LineString","coordinates":[[120.976644,14.658362],[120.976745,14.658318],[120.97663,14.658263],[120.976384,14.6583],[120.97641,14.65836],[120.975741,14.65866],[120.976074,14.659115],[120.976043,14.659173],[120.976183,14.659236],[120.976161,14.659283]]},"id":"1a5a2938e0ccb6b69fbb46a8b84afb5b"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 2nd Elevator","to":"Chapel"},"geometry":{"type":"LineString","coordinates":[[120.977179,14.658611],[120.977227,14.65853],[120.976621,14.65826],[120.976381,14.658299],[120.976411,14.658365],[120.975766,14.658646],[120.975638,14.658525],[120.975719,14.658054],[120.975649,14.658039]]},"id":"224c036a244a85716e034cca6f052c77"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Admission Building"},"geometry":{"type":"LineString","coordinates":[[120.976197,14.657858],[120.976391,14.658304],[120.97642,14.658367],[120.976196,14.658439]]},"id":"265cb9995d22e4cfe481a3b74bd037c4"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 2nd Elevator","to":"Lobby"},"geometry":{"type":"LineString","coordinates":[[120.977173,14.658616],[120.977233,14.658535],[120.976635,14.658268],[120.976374,14.658303],[120.976086,14.658422]]},"id":"27db1ae1bb9ad8fe46ed3dae57006ee4"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 2nd Elevator","to":"Gym"},"geometry":{"type":"LineString","coordinates":[[120.977173,14.658613],[120.97723,14.658532],[120.976628,14.65826],[120.976379,14.658304],[120.97641,14.65836],[120.975766,14.658646],[120.975632,14.658521]]},"id":"32d2aec6d70f9c0e4549e74cef30dce8"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 2nd Elevator","to":"Admission Building"},"geometry":{"type":"LineString","coordinates":[[120.977181,14.658612],[120.97723,14.658527],[120.976629,14.658264],[120.976358,14.658308],[120.976079,14.658428]]},"id":"3565deb50639760e13f913d9a2570d40"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 2nd Elevator","to":"Field"},"geometry":{"type":"LineString","coordinates":[[120.977179,14.658617],[120.977232,14.658533],[120.977024,14.658448],[120.976918,14.658673]]},"id":"3570f147caa95767a5b9327b3e28bf37"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Chapel"},"geometry":{"type":"LineString","coordinates":[[120.976199,14.65785],[120.976416,14.658359],[120.975766,14.65865],[120.975639,14.658524],[120.975723,14.658053],[120.975646,14.658039]]},"id":"4610071241e1ac51e433d3a26d16f215"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 1st Elevator","to":"Field"},"geometry":{"type":"LineString","coordinates":[[120.97665,14.658362],[120.976735,14.658322],[120.977028,14.658446],[120.976919,14.658668]]},"id":"59148557204490e5f4d09ab0f511dba7"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 1st Elevator","to":"Lobby"},"geometry":{"type":"LineString","coordinates":[[120.976648,14.658362],[120.976739,14.658317],[120.976623,14.658261],[120.976491,14.658284]]},"id":"5b28c5581df796e3bbec878b3969aee5"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 2nd Elevator","to":"Student Affairs Office"},"geometry":{"type":"LineString","coordinates":[[120.977177,14.658612],[120.97723,14.658534],[120.976626,14.658264],[120.976386,14.658298],[120.976416,14.658356],[120.975737,14.658663],[120.976071,14.659114],[120.976043,14.659174],[120.976187,14.659231],[120.97616,14.659279]]},"id":"61789e56393ceb8b8376183a8f827dde"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 1st Elevator","to":"Engineering Building Right Side Entrance"},"geometry":{"type":"LineString","coordinates":[[120.976646,14.658362],[120.976731,14.658318],[120.977752,14.658797],[120.977964,14.658909],[120.977968,14.65901]]},"id":"6719132df28000ff2e09203dc14fe624"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 1st Elevator","to":"HRM Mockup Building"},"geometry":{"type":"LineString","coordinates":[[120.976652,14.658363],[120.976736,14.658321],[120.977721,14.658786]]},"id":"72a44a0e529c5c05bd05d18cc4301b9b"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Canteen"},"geometry":{"type":"LineString","coordinates":[[120.976199,14.657851],[120.976395,14.658304],[120.976605,14.658269],[120.977399,14.658605],[120.977321,14.658722]]},"id":"75e4c50bf206b018af30b511e7308c5e"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 1st Elevator","to":"Admission Building"},"geometry":{"type":"LineString","coordinates":[[120.976649,14.658363],[120.976679,14.658343],[120.976637,14.6583],[120.976103,14.658492],[120.976045,14.658388]]},"id":"7828c9ec318fcf79cce6919528931294"},
    {"type":"Feature","properties":{"Building":"HRM Mock Up Building"},"geometry":{"type":"Point","coordinates":[120.977735,14.658825]},"id":"7fd74f2ed5df921e8ddc58882ea0b8c7"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 2nd Elevator","to":"Lucio Tan Building"},"geometry":{"type":"LineString","coordinates":[[120.977182,14.658612],[120.977232,14.658528],[120.977023,14.658449],[120.976947,14.658609],[120.977038,14.65865],[120.976654,14.659433],[120.977064,14.659598]]},"id":"82cbcd1d7a3e3e0b43bcba4259d44719"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Tyk First Elevator"},"geometry":{"type":"LineString","coordinates":[[120.976195,14.657865],[120.976411,14.658361],[120.976651,14.658299],[120.976683,14.658347],[120.976646,14.658365]]},"id":"8347f902d9878f48c3f29ee13319e6ad"},
    {"type":"Feature","properties":{},"geometry":{"type":"LineString","coordinates":[[120.976106,14.658494],[120.976417,14.658361],[120.976383,14.658299],[120.976626,14.658261],[120.976735,14.65832]]},"id":"8e0e882e9d1dbe431fd58c32dff65cd9"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 2nd Elevator","to":"HRM Mockup Building"},"geometry":{"type":"LineString","coordinates":[[120.977178,14.658613],[120.977222,14.658542],[120.977746,14.658819]]},"id":"aa96838b7e6bade33161fe079443d546"},
    {"type":"Feature","properties":{"Building":"HRM Mock Up Building #2"},"geometry":{"type":"Point","coordinates":[120.977649,14.658923]},"id":"ad09138797b0308277d2be5a0e999516"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Lucio Tan Building"},"geometry":{"type":"LineString","coordinates":[[120.976197,14.657846],[120.976416,14.658363],[120.976357,14.65838],[120.976394,14.658467],[120.976561,14.658476],[120.977021,14.658674],[120.976685,14.659371],[120.976653,14.659431],[120.977069,14.659595]]},"id":"b3b5b371c6cd357ffcb2eee6eed2aff8"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Student Affairs Office"},"geometry":{"type":"LineString","coordinates":[[120.976203,14.657847],[120.976416,14.658361],[120.975926,14.658571],[120.975737,14.658665],[120.975905,14.658878],[120.976068,14.659106],[120.976043,14.659172],[120.976185,14.659232],[120.976168,14.659265]]},"id":"bdd6d2ff725f6039d8af22bfcf68a5eb"},
    {"type":"Feature","properties":{"Entrance":"Back Entrance ( Entry Point of Vehicle )"},"geometry":{"type":"Point","coordinates":[120.975512,14.657939]},"id":"c2ea42da56637c97d191075eb875ec83"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 1st Elevator","to":"Lucio Tan Building"},"geometry":{"type":"LineString","coordinates":[[120.976646,14.658362],[120.976744,14.658321],[120.976629,14.658261],[120.976385,14.658303],[120.976413,14.658366],[120.975735,14.658663],[120.97607,14.659112],[120.976039,14.659175],[120.976183,14.659236],[120.97707,14.659601]]},"id":"cefc93c163749b82ea95db9ba9ad2e60"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 1st Elevator","to":"Gym"},"geometry":{"type":"LineString","coordinates":[[120.976647,14.658358],[120.976742,14.658314],[120.976614,14.658261],[120.976389,14.658298],[120.976407,14.658359],[120.975769,14.658649],[120.975637,14.658517],[120.97572,14.65806],[120.975652,14.658038]]},"id":"d666f7da15c42c544472f4ea55e47844"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Tyk Second Elevator"},"geometry":{"type":"LineString","coordinates":[[120.976201,14.657847],[120.976415,14.658358],[120.976651,14.658301],[120.97713,14.658541],[120.977095,14.658594]]},"id":"de2e9c6f673ec49061d6d7dab4f67903"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Engineering Building Right Side Entrance"},"geometry":{"type":"LineString","coordinates":[[120.976204,14.657843],[120.976389,14.658304],[120.976602,14.658268],[120.977132,14.658501],[120.977517,14.658649],[120.977694,14.658759],[120.977927,14.658892],[120.977964,14.659012]]},"id":"de49cc62abba79b2cc3ad6262987515f"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Engineering Building Left Side Entrance"},"geometry":{"type":"LineString","coordinates":[[120.976211,14.657858],[120.976416,14.65836],[120.975741,14.658663],[120.976061,14.659104],[120.976043,14.659168],[120.976571,14.659405],[120.977068,14.659597],[120.977404,14.659732],[120.977612,14.659798],[120.977553,14.659895]]},"id":"f7b386db2efffe6b8db22829211f8789"},
    {"type":"Feature","properties":{"type":"path","from":"TYK 1st Elevator","to":"Canteen"},"geometry":{"type":"LineString","coordinates":[[120.976646,14.658368],[120.976677,14.658343],[120.976685,14.658323],[120.977397,14.658604],[120.977337,14.658695]]},"id":"f8ae55e1c76a40c10a371c9cbc9394df"},
    {"type":"Feature","properties":{"type":"path","from":"Gate","to":"Ue Parking"},"geometry":{"type":"LineString","coordinates":[[120.976201,14.65783],[120.976307,14.658085],[120.976372,14.658114],[120.976505,14.658083],[120.976552,14.658082],[120.977699,14.65867],[120.978049,14.658874],[120.978445,14.659089],[120.978479,14.659186],[120.978375,14.65933],[120.97831,14.659358],[120.978211,14.659304]]},"id":"fa373d1de0a2cb129d277c4995e44bd4"}
  ]
}
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>

  <script>
    (function () {
      const PATHS = JSON.parse(document.getElementById("ue-paths-json").textContent);
      const CAMPUS = JSON.parse(document.getElementById("ue-campus-json").textContent);

      const ALIASES = {
        GATE: ["Gate", "Main Gate", "Front Gate", "UE Gate"],
        EN_RIGHT: [
          "Engineering Building Right Side Entrance",
          "Engineering Building Right Entrance",
          "EN Right Entrance",
          "Engineering Right Side Entrance",
        ],
        TYK: ["Tan Yan Kee", "TYK", "TYK Building", "Tan Yan Kee Building"],
        TYK_ELEV_1: ["TYK 1st Elevator", "Tyk First Elevator", "TYK First Elevator"],
        TYK_ELEV_2: ["TYK 2nd Elevator", "Tyk Second Elevator", "TYK Second Elevator"],
        LCT: ["Lucio Tan", "Lucio Tan Building", "LCT", "LCT Building"],
        UEC_MAIN: ["UEC Main", "UEC Main Building", "Main Campus", "Main Building", "UEC_MAIN"],
      };

      const SPECIAL_TO_TO_NAME = {
        campus_chapel: "Chapel",
        canteen_santino: "Canteen",
        admission_office: "Admission Building",
        comptroller_office: "Admission Building",
        registrar_office: "Registrar's Office",
        student_affairs_office: "Student Affairs Office",
        hrm_mock_building: "HRM Mockup Building",
        medical_dental_clinic: "Admission Building",
        gymnasium: "Gym",
        pe_office: "Gym",
      };

      const DEFAULT_TO_BY_BUILDING = {
        EN: "Engineering Building Right Side Entrance",
        LCT: "Lucio Tan Building",
        TYK: "Tyk First Elevator",
        UEC_MAIN: "Student Affairs Office",
      };

      let map, routeLayer, campusLayer, walker, animRAF;

      function ensureMap() {
        if (map) { map.off(); map.remove(); map = null; }
        map = L.map("ueSlipMap");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 20, attribution: "¬© OpenStreetMap",
        }).addTo(map);

        campusLayer = L.geoJSON(CAMPUS, {
          pointToLayer: (feat, latlng) => {
            const p = feat.properties || {};
            const label = p.Entrance || p.Building || p.Field || "";
            return label
              ? L.marker(latlng, { icon: L.divIcon({ className: "poi", html: label }) })
              : L.circleMarker(latlng, { radius: 3, color: "#999" });
          },
          style: (_) => ({ color: "#999", weight: 1, opacity: 0.6 }),
        }).addTo(map);

        routeLayer = L.geoJSON(null, { style: { color: "#b3202b", weight: 5, opacity: 0.95 } }).addTo(map);

        walker = L.marker([0, 0], {
          icon: L.divIcon({
            className: "",
            html: '<div class="walker">üö∂‚Äç‚ôÇÔ∏è</div>',
            iconSize: [20, 20],
            iconAnchor: [10, 12],
          }),
          interactive: false,
        }).addTo(map);
      }

      function findRoute(toName) {
        return (PATHS.features || []).find(
          (f) => f.properties?.type === "path" && f.properties.from === "Gate" && f.properties.to === toName
        );
      }

      const toLLs = (coords) => coords.map(([lng, lat]) => L.latLng(lat, lng));

      function animateAlong(coords, s = 25) {
        if (animRAF) cancelAnimationFrame(animRAF);
        const pts = toLLs(coords);
        if (pts.length < 2) return;
        const seg = [];
        for (let i = 0; i < pts.length - 1; i++) seg.push(map.distance(pts[i], pts[i + 1]));
        let k = 0, prog = 0, prev = null;
        const mix = (A, B, t) => L.latLng(A.lat + (B.lat - A.lat) * t, A.lng + (B.lng - A.lng) * t);
        function step(t) {
          if (prev === null) { prev = t; return (animRAF = requestAnimationFrame(step)); }
          let dt = (t - prev) / 1000; prev = t; let d = s * dt;
          while (d > 0 && k < seg.length) {
            const left = seg[k] - prog;
            if (d < left) { prog += d; d = 0; }
            else { d -= left; k++; prog = 0; }
          }
          if (k >= seg.length) { k = 0; prog = 0; }
          const A = pts[k], B = pts[k + 1], tt = seg[k] ? prog / seg[k] : 0;
          walker.setLatLng(mix(A, B, tt));
          animRAF = requestAnimationFrame(step);
        }
        walker.setLatLng(pts[0]);
        animRAF = requestAnimationFrame(step);
      }

      function draw(toName) {
        routeLayer.clearLayers();
        const ft = findRoute(toName);
        if (!ft) return console.warn("Missing path", toName);
        routeLayer.addData(ft);
        const b = routeLayer.getBounds().pad(0.25);
        if (b.isValid()) map.fitBounds(b);
        animateAlong(ft.geometry.coordinates);
      }

      function pickToName(buildingCode, specialKey) {
        if (buildingCode === "UEC_MAIN" && specialKey) {
          return SPECIAL_TO_TO_NAME[specialKey] || DEFAULT_TO_BY_BUILDING[buildingCode];
        }
        return DEFAULT_TO_BY_BUILDING[buildingCode];
      }

      window.UErouteMap = {
        show(buildingCode, specialKey = null) {
          const toName = pickToName(buildingCode, specialKey);
          ensureMap();
          setTimeout(() => { map.invalidateSize(); draw(toName); }, 40);
          return toName;
        },
      };

      window.UE_ALIASES = ALIASES;
    })();

    (function lockRoomDescription() {
      const ID = "m-roominfo";
      const el = document.getElementById(ID);
      if (!el) return;

      if (el.tagName.toLowerCase() === "textarea") {
        const div = document.createElement("div");
        div.id = ID;
        div.className = el.className || "";
        div.style.cssText = el.style.cssText || "";
        div.textContent = el.value || el.textContent || "‚Äî";
        el.replaceWith(div);
      }

      const box = document.getElementById(ID);
      box.setAttribute("aria-readonly", "true");
      box.setAttribute("role", "note");
      box.setAttribute("tabindex", "-1");
      box.contentEditable = "false";

      window.__setRoomDescText = function (text) {
        box.textContent = text || "No description available.";
      };
      window.__setRoomDescHTML = function (html) {
        box.innerHTML = html || "No description available.";
      };
    })();

    (function () {
      document.getElementById("yy").textContent = new Date().getFullYear();
      const vDate = document.getElementById("vDate"),
        todayISO = new Date().toISOString().slice(0, 10);
      vDate.value = todayISO;
      vDate.max = todayISO;

      const firebaseConfig = {
        apiKey: "AIzaSyAO-rovSC2xK4ZUV9pD3ixKViQl9x4xzNk",
        authDomain: "rushue-234bc.firebaseapp.com",
        databaseURL: "https://rushue-234bc-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "rushue-234bc",
        storageBucket: "rushue-234bc.appspot.com",
        messagingSenderId: "574730836644",
        appId: "1:574730836644:web:ff7c9e9eae7fc498e4a431",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      function ensureAuthCompat() {
        return new Promise((resolve) => {
          if (firebase.auth) return resolve();
          const s = document.createElement("script");
          s.src = "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js";
          s.onload = resolve;
          s.onerror = resolve;
          document.head.appendChild(s);
        });
      }

      const authReady = (async function () {
        await ensureAuthCompat();
        if (!firebase.auth) return null;
        return new Promise((resolve) => {
          firebase.auth().onAuthStateChanged((u) => {
            if (u) return resolve(u);
            firebase.auth().signInAnonymously().catch((err) => {
              console.warn("Anonymous auth failed:", err);
              resolve(null);
            });
          });
        });
      })();

      const toast = (msg) => {
        const el = document.createElement("div");
        el.className = "ue-toast";
        el.textContent = msg;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 2200);
      };

      const bldgSel = document.getElementById("bldg");
      const roomInput = document.getElementById("roomInput"),
        roomList = document.getElementById("roomList");
      const profInput = document.getElementById("profInput"),
        profList = document.getElementById("profList");

      const roomCol = document.getElementById("roomCol") || roomInput.closest(".col-12");
      const profCol = document.getElementById("profCol") || profInput.closest(".col-12");

      const mDestination = document.getElementById("m-destination"),
        mDate = document.getElementById("m-date"),
        mPurpose = document.getElementById("m-purpose"),
        mDirections = document.getElementById("m-directions");

      const modalEl = document.getElementById("routeModal"),
        modal = new bootstrap.Modal(modalEl);

      const profChoiceWrap = document.getElementById("profChoiceWrap");
      const profChoice = document.getElementById("profChoice");

      const purposeSelEl = document.getElementById("vPurpose"),
        otherWrap = document.getElementById("otherWrap"),
        other = document.getElementById("vPurposeOther");
      function upd() {
        if (purposeSelEl.value === "__OTHER__") {
          otherWrap.classList.remove("d-none");
          other.required = true;
          other.focus();
        } else {
          otherWrap.classList.add("d-none");
          other.required = false;
          other.value = "";
        }
      }
      purposeSelEl.addEventListener("change", upd);
      upd();

      let campusData = null,
        currentBuildingCode = null,
        currentSpecialKey = null;
      db.ref("/")
        .get()
        .then((s) => (campusData = s.val() || {}))
        .catch((e) => console.warn("DB read failed:", e));

      const norm = (s) => String(s || "").trim().toLowerCase().replace(/\s+/g, "_");

      function syncRoomProfExclusivity() {
        const roomHas = roomInput.value.trim().length > 0;
        const profHas = profInput.value.trim().length > 0;

        if (roomHas) {
          profInput.value = "";
          profInput.disabled = true;
          profCol.classList.add("d-none");
        } else {
          profInput.disabled = false;
          profCol.classList.remove("d-none");
        }
        if (profHas) {
          roomInput.value = "";
          roomInput.disabled = true;
          roomCol.classList.add("d-none");
        } else if (!roomHas) {
          roomInput.disabled = false;
          roomCol.classList.remove("d-none");
        }
      }
      roomInput.addEventListener("input", syncRoomProfExclusivity);
      profInput.addEventListener("input", syncRoomProfExclusivity);
      syncRoomProfExclusivity();

      function fillRooms(code) {
        roomList.innerHTML = "";
        if (!code || !campusData?.[code]) return;
        const items = new Set();

        if (code === "UEC_MAIN") {
          Object.keys(campusData[code]?.special_rooms || {}).forEach((k) => items.add(k));
        } else {
          const floors = campusData[code]?.floors || {};
          Object.keys(floors).forEach((fk) => {
            const node = floors[fk];
            const rooms = node?.rooms || node || {};
            Object.keys(rooms).forEach((rk) => items.add(rk));
          });
        }

        const fr = campusData[code]?.faculty?.f_room || {};
        Object.values(fr).forEach((group) => {
          Object.values(group || {}).forEach((prof) => {
            if (prof && prof.schedule) Object.keys(prof.schedule).forEach((rk) => items.add(rk));
          });
        });

        const sorted = [...items].sort((a, b) => a.localeCompare(b));
        roomList.innerHTML = sorted.map((v) => `<option value="${v}"></option>`).join("");
      }

      function fillProfs(code) {
        profList.innerHTML = "";
        if (!code || !campusData?.[code]) return;
        const set = new Set();
        const fr = campusData[code]?.faculty?.f_room || {};
        Object.values(fr).forEach((group) => {
          Object.keys(group || {}).forEach((name) => { if (name !== "schedule") set.add(name); });
        });
        const arr = [...set].sort((a, b) => a.localeCompare(b));
        profList.innerHTML = arr.map((v) => `<option value="${v}"></option>`).join("");
      }

      bldgSel.addEventListener("change", () => {
        roomInput.value = "";
        profInput.value = "";
        currentSpecialKey = null;
        fillRooms(bldgSel.value);
        fillProfs(bldgSel.value);
        syncRoomProfExclusivity();
      });

      async function fetchRoomNode(code, roomKeyRaw) {
        let roomKey = roomKeyRaw;

        if (code === "UEC_MAIN") {
          const sr = await db.ref(`/UEC_MAIN/special_rooms/${roomKey}`).get();
          return { exists: sr.exists(), data: sr.val() || {}, key: roomKey };
        }

        const num = (roomKey.match(/-(\d+)/) || [])[1];
        const firstDigit = num ? String(num).charAt(0) : null;
        if (firstDigit) {
          const guessPath = `/${code}/floors/${firstDigit}F/rooms/${roomKey}`;
          const guessSnap = await db.ref(guessPath).get();
          if (guessSnap.exists()) return { exists: true, data: guessSnap.val() || {}, key: roomKey };
        }

        if (!roomKey.startsWith(code + "-")) {
          const prefixed = `${code}-${roomKey}`;
          const floorsSnap = await db.ref(`/${code}/floors`).get();
          const floors = floorsSnap.val() || {};
          for (const [, floorNode] of Object.entries(floors)) {
            const roomsNode = floorNode?.rooms || floorNode || {};
            if (prefixed in roomsNode) return { exists: true, data: roomsNode[prefixed] || {}, key: prefixed };
          }
        }

        const floorsSnap2 = await db.ref(`/${code}/floors`).get();
        const floors2 = floorsSnap2.val() || {};
        for (const [, floorNode] of Object.entries(floors2)) {
          const roomsNode = floorNode?.rooms || floorNode || {};
          if (roomKey in roomsNode) return { exists: true, data: roomsNode[roomKey] || {}, key: roomKey };
        }

        for (const [, floorNode] of Object.entries(floors2)) {
          const roomsNode = floorNode?.rooms || floorNode || {};
          for (const rk of Object.keys(roomsNode)) {
            if (norm(rk) === norm(roomKey)) return { exists: true, data: roomsNode[rk] || {}, key: rk };
          }
        }

        return { exists: false, data: {}, key: roomKeyRaw };
      }

      function getProfessorInfoAndChoices(code, profName) {
        const fr = campusData?.[code]?.faculty?.f_room || {};
        const out = { prof: null, choices: [] };
        for (const [, group] of Object.entries(fr)) {
          if (group && group[profName]) {
            out.prof = group[profName];
            const sched = group[profName].schedule || {};
            for (const [rk, timeStr] of Object.entries(sched)) out.choices.push({ roomKey: rk, timeStr });
            break;
          }
        }
        return out;
      }

      function buildDescriptionText(room) {
        if (room?.exists) {
          const d = room.data || {};
          const rdesc = d.description || d.desc || d.Remarks || d.remarks || "";
          const descriptions = [];

          descriptions.push(rdesc);  

          for (let i = 2; i <= 6; i++) {
            if (d[`description${i}`]) {
              descriptions.push(d[`description${i}`]);
            }
          }

          return descriptions.map(desc => `${desc}\n`).join("\n");  
        }
        return "No description available.";  
      }



      async function showDescription(room) {
        const description = buildDescriptionText(room);  
        document.getElementById('m-roominfo').textContent = description;  
      }


      function showProfChoices(choices) {
        profChoice.innerHTML = choices
          .map((c) => {
            const rest = c.roomKey.replace(/^[A-Z_]+-/, "");
            const firstDigit = (rest.match(/(\d)/) || [])[1];
            const floor = firstDigit
              ? firstDigit === "1"
                ? "1st"
                : firstDigit === "2"
                  ? "2nd"
                  : firstDigit === "3"
                    ? "3rd"
                    : `${firstDigit}th`
              : "";
            const label = `${c.timeStr || "‚Äî"} ‚Äî ${c.roomKey}${floor ? ` (floor ${floor})` : ""}`;
            return `<option value="${c.roomKey}">${label}</option>`;
          })
          .join("");
        profChoiceWrap.classList.remove("d-none");
      }

      async function saveVisitorSlip(db, data) {
        const [Y, M, D] = (data.date || "").split("-");
        const basePath = (Y && M && D)
          ? `/visitor_slips/${Y}/${M}/${D}`
          : `/visitor_slips/unsorted`;

        const ref = db.ref(basePath).push();
        const payload = {
          ...data,
          createdAt: firebase.database.ServerValue.TIMESTAMP,
        };
        await ref.set(payload);
        return ref.key;
      }

      document.getElementById("visitorForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("vName").value.trim();
        const email = document.getElementById("vEmail").value.trim();
        const date = document.getElementById("vDate").value;
        const code = bldgSel.value;
        const roomKeyIn = roomInput.value.trim();
        const profName = profInput.value.trim();
        const purpose =
          purposeSelEl.value === "__OTHER__" ? (other.value || "").trim() : purposeSelEl.value;

        const errs = [];
        if (!name) errs.push("Name is required");
        if (!/^\S+@\S+\.\S+$/.test(email)) errs.push("Valid email is required");
        if (!date) errs.push("Date is required");
        if (!code) errs.push("Building is required");
        if (!purpose) errs.push("Purpose is required");
        if (!profName && !roomKeyIn) errs.push("Select a room OR a professor.");
        if (errs.length) return toast(errs.join("\n"));

        try { await authReady; } catch (_) { }

        try {
          const slip = {
            name,
            email,
            date,
            building: code,
            room: roomKeyIn || null,
            professor: profName || null,
            purpose,
          };
          await saveVisitorSlip(db, slip);
        } catch (err) {
          console.error("Could not save slip:", err);
          toast("Could not save slip. " + (err && err.code ? err.code : "Please try again."));
          return;
        }

        mDestination.textContent = profName ? `${profName} (${code})` : roomKeyIn || code;
        mDate.textContent = date;
        mPurpose.textContent = purpose;

        currentBuildingCode = code;
        currentSpecialKey = code === "UEC_MAIN" && roomKeyIn ? roomKeyIn : null;

        profChoiceWrap.classList.add("d-none");
        __setRoomDescText("");
        mDirections.innerHTML = "";

        modal.show();
      });

      document.getElementById("routeModal").addEventListener("shown.bs.modal", async () => {
        const toName = UErouteMap.show(currentBuildingCode, currentSpecialKey);

        const code = bldgSel.value;
        const roomKeyIn = roomInput.value.trim();
        const profName = profInput.value.trim();

        const routeText = `<strong>Route:</strong> Gate ‚Üí ${toName}`;

        if (roomKeyIn) {
          const room = await fetchRoomNode(code, roomKeyIn);
          mDirections.innerHTML = routeText;
          __setRoomDescText(buildDescriptionText(room));
          return;
        }

        const { prof, choices } = getProfessorInfoAndChoices(code, profName);
        if (!prof) {
          mDirections.innerHTML = `${routeText}<br>No professor data found in ${code}.`;
          __setRoomDescText("No description available.");
          return;
        }

        const resolved = [];
        for (const c of choices) {
          const rn = await fetchRoomNode(code, c.roomKey);
          resolved.push({ ...c, rn });
        }

        if (resolved.length === 0) {
          mDirections.innerHTML = `${routeText}<br>No schedule found for ${profName} in ${code}.`;
          __setRoomDescText("No description available.");
          return;
        }

        showProfChoices(resolved);
        const first = resolved[0];
        mDirections.innerHTML = `<strong>Schedule:</strong> ${first.timeStr || "N/A"}<br>${routeText}`;
        __setRoomDescText(buildDescriptionText(first.rn));

        profChoice.onchange = async () => {
          const rk = profChoice.value;
          const pick = resolved.find((x) => x.roomKey === rk);
          const rn = pick?.rn?.exists ? pick.rn : await fetchRoomNode(code, rk);
          mDirections.innerHTML = `<strong>Schedule:</strong> ${pick?.timeStr || "N/A"}<br>${routeText}`;
          __setRoomDescText(buildDescriptionText(rn));
        };
      });

      document.getElementById("routeModal").addEventListener("hidden.bs.modal", () => {
        document.getElementById("btnClear").click();
        toast("Visitor‚Äôs slip saved and form cleared.");
      });

      document.getElementById("btnClear").addEventListener("click", () => {
        document.getElementById("visitorForm").reset();
        vDate.value = todayISO;
        roomInput.value = "";
        profInput.value = "";
        currentSpecialKey = null;
        currentBuildingCode = null;
        profChoiceWrap.classList.add("d-none");
        fillRooms(bldgSel.value);
        fillProfs(bldgSel.value);
        syncRoomProfExclusivity();
      });
    })();
  </script>

  <script>
    function showMessage(message) {
      const toastEl = document.getElementById('custom-toast');
      const toastBody = document.getElementById('toast-message');
      toastBody.textContent = message;

      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();
    }

    window.showPage = function (pageId) {
      const pages = document.querySelectorAll('.page-content');
      pages.forEach(page => {
        page.classList.remove('active');
      });

      const targetPage = document.getElementById(pageId + '-page');
      if (targetPage) {
        targetPage.classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }


    window.toggleTheme = function () {
      const body = document.body;
      const sunIcon = document.getElementById('sun-icon');
      const moonIcon = document.getElementById('moon-icon');

      if (body.classList.contains('light-mode')) {
        body.classList.remove('light-mode');
        body.classList.add('dark-mode');
        sunIcon.style.display = 'none';
        moonIcon.style.display = 'inline-block';
        showMessage('Switched to Dark Mode');
        localStorage.setItem('theme', 'dark-mode');
      } else {
        body.classList.remove('dark-mode');
        body.classList.add('light-mode');
        sunIcon.style.display = 'inline-block';
        moonIcon.style.display = 'none';
        showMessage('Switched to Light Mode');
        localStorage.setItem('theme', 'light-mode');
      }
    }

    function applyInitialTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light-mode';
      document.body.classList.add(savedTheme);
      const sunIcon = document.getElementById('sun-icon');
      const moonIcon = document.getElementById('moon-icon');

      if (savedTheme === 'dark-mode') {
        sunIcon.style.display = 'none';
        moonIcon.style.display = 'inline-block';
      } else {
        sunIcon.style.display = 'inline-block';
        moonIcon.style.display = 'none';
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      applyInitialTheme();

      const today = new Date();
      const formattedDate = today.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric"
      });
      document.getElementById("current-date").textContent = formattedDate;

      if (!sessionStorage.getItem("announcementShown")) {
        const modal = new bootstrap.Modal(document.getElementById("announcementModal"));
        modal.show();
        sessionStorage.setItem("announcementShown", "true");
      }

      showPage('dashboard');
    });
  </script>

</body>

</html>